<%
  # use privatekey from _form.html.erb 
  key = OpenSSL::PKey::RSA.new @keypair.privatekey

  options = { 
    :commonname       => params[:cn],
    :organization     => params[:o],
    :org_unit         => params[:ou],
    :location         => params[:l],
    :state            => params[:s],
    :country          => params[:c],
    :email            => params[:email]
  }
  
  request = OpenSSL::X509::Request.new
  request.version    = 0 
  request.subject    = OpenSSL::X509::Name.new([
    ['CN',             options[:commonname],   OpenSSL::ASN1::UTF8STRING],
    ['O',              options[:organization], OpenSSL::ASN1::UTF8STRING],
    ['OU',             options[:org_unit],     OpenSSL::ASN1::UTF8STRING],
    ['L',              options[:location],     OpenSSL::ASN1::PRINTABLESTRING],
    ['ST',             options[:state],        OpenSSL::ASN1::PRINTABLESTRING],
    ['C',              options[:country],      OpenSSL::ASN1::PRINTABLESTRING],
    ['emailAddress',   options[:email],        OpenSSL::ASN1::UTF8STRING]
  ])  

  request.public_key = (OpenSSL::PKey::RSA.new @keypair.privatekey).public_key

  request.sign(key, OpenSSL::Digest::SHA512.new)

%>

// only fill name-field with autogenerated name if it is empty
if( $('#name').val().length === 0 ) {
  $('#name').val ('Autogenerated CSR: <%= j DateTime.now.to_s(:number) %>');
}

// fill csr content into forms content field
$('#content').val ('<%= j request.to_pem.html_safe %>');
